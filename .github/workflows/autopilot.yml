name: Legal Video Autopilot

on:
  schedule:
    - cron: '0 */8 * * *'  # Every 8 hours
  workflow_dispatch:  # Manual trigger

jobs:
  generate-video:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Set up FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3
      id: setup-ffmpeg
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        pip install moviepy
        pip install gtts
        pip install pillow
        pip install numpy
        echo "✅ All Python packages installed successfully"
    
    - name: Verify installations
      run: |
        echo "🔍 Verifying installations..."
        python -c "import moviepy; print('✅ MoviePy:', moviepy.__version__)"
        python -c "import requests; print('✅ Requests installed')"
        python -c "import gtts; print('✅ gTTS installed')"
        ffmpeg -version | head -1
        echo "✅ All verifications passed"
    
    - name: Run autopilot script with debugging
      env:
        HF_API_KEY: ${{ secrets.HF_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
      run: |
        echo "Starting autopilot script..."
        python autopilot.py
    
    - name: Upload generated videos
      uses: actions/upload-artifact@v3
      if: always()  # Upload even if there are errors
      with:
        name: legal-videos
        path: |
          *.mp4
          *.json
          *.mp3
          *.png
        retention-days: 30
    
    - name: List all generated files
      if: always()
      run: |
        echo "📁 Files in current directory:"
        ls -la
        echo "🎬 Video files:"
        ls -la *.mp4 2>/dev/null || echo "No MP4 files found"
